name: Run MongoDB Server
on: [push, pull_request]
jobs:
  mongodb-action:
    name: Run MongoDB Server v${{ matrix.mongodb-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mongodb-version: ['4.4.14', '5.0.9']
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Start  Server
        uses: ./
        with:
          mongodb-version: ${{ matrix.mongodb-version }}
      - name: Install pnpm
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 6.0.2
      - name: install conventional-changelog-cli
        run: pnpm install -g conventional-changelog-cli
      - name: install conventional-github-release
        run: pnpm install -g conventional-github-releaser
      - name: Generate ChangeLog
        run: conventional-changelog -p conventionalcommits -i CHANGELOG.md -s -r 0 -n ./changelog/config.js
      - name: Push Changes of ChangeLog
        run: |
          git config --global user.email "ci@mongocamp.dev"
          git config --global user.name "MongoCamp CI"
          git add CHANGELOG.md
          git commit -a 'Generated ChangeLog'
          git push
      - name: Release
        env:
          CONVENTIONAL_GITHUB_RELEASER_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          git config --global user.email "ci@mongocamp.dev"
          git config --global user.name "MongoCamp CI"
          conventional-github-releaser -p conventionalcommits -r 0 -n ./changelog/config.js